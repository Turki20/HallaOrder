{% extends "home/base.html" %}
{% load static %}

{% block title %}إدارة المنتجات{% endblock title %}

{% block style %}
    <link rel="stylesheet" href="{% static 'css/menu.css' %}">
{% endblock style %}

{% block dashboard_content %}

<div class="page-header mb-3 p-4">
    <h1>المنتجات</h1>
    <div class="d-flex gap-2 justify-content-end">
        <button id="manageCategoriesBtn" class="btn btn-blue"><i class="fas fa-sitemap"></i> إدارة الفئات</button>
        <button id="addProductBtn" class="btn btn-orange"><i class="fas fa-plus"></i> إضافة منتج جديد</button>
    </div>
</div>

<div class="products-container card">
    <div class="category-tabs">
        {% for category in categories %}
        <button class="tab-btn {% if forloop.first %}active{% endif %}" data-target="category-{{ category.id }}">{{ category.name }}</button>
        {% endfor %}
    </div>
    <div class="products-content">
        {% for category in categories %}
        <section class="category-section {% if forloop.first %}active{% endif %}" id="category-{{ category.id }}">
            <div class="category-header"><h2>{{ category.name }}</h2></div>
            <table class="products-table">
               <thead><tr><th>المنتج</th><th>السعر</th><th>الحالة</th><th>إجراءات</th></tr></thead>
               <tbody>
                   {% for product in category.product_set.all %}
                   <tr>
                       <td>
                           <div class="product-info">
                               {% if product.image %}
                               <img src="{{ product.image.url }}" alt="{{ product.name }}">
                               {% endif %}
                               <div>
                                   <strong>{{ product.name }}</strong>
                                   {% if product.description %}
                                   <div class="text-muted small">{{ product.description|truncatewords:10 }}</div>
                                   {% endif %}
                               </div>
                           </div>
                       </td>
                       <td>{{ product.price }} ر.س</td>
                       <td>
                           <label class="toggle-switch">
                               <input type="checkbox" {% if product.available %}checked{% endif %} data-product-id="{{ product.id }}">
                               <span class="slider"></span>
                           </label>
                       </td>
                       <td>
                           <div class="action-buttons">
                               <a href="{% url 'menu:edit_product' product.id %}" class="action-btn edit-btn"><i class="fas fa-pen"></i></a>
                               <form method="POST" action="{% url 'menu:delete_product' product.id %}" onsubmit="return confirm('هل أنت متأكد من حذف هذا المنتج؟');" style="display: inline;">
                                   {% csrf_token %}
                                   <button type="submit" class="action-btn delete-btn"><i class="fas fa-trash"></i></button>
                               </form>
                           </div>
                       </td>
                   </tr>
                   {% empty %}
                   <tr><td colspan="4" class="text-center text-muted">لا توجد منتجات في هذه الفئة.</td></tr>
                   {% endfor %}
               </tbody>
            </table>
        </section>
        {% endfor %}
    </div>
</div>

<!-- Manage Categories Modal -->
<div id="manageCategoriesModal" class="modal-overlay">
    <div class="modal-content">
        <header class="modal-header">
            <h2>إدارة الفئات الرئيسية</h2>
            <button class="close-btn">&times;</button>
        </header>
        <main class="modal-body row">
            <div class="add-category-section col-12">
                <form method="POST" action="{% url 'menu:menu_view' %}">
                    {% csrf_token %}
                    <h3>إضافة فئة جديدة</h3>
                    <div class="form-group">
                        <label for="new-cat-name">اسم الفئة</label>
                        <input type="text" name="name" id="new-cat-name" placeholder="مثال: المشروبات" required>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" name="add_category" class="btn btn-orange">حفظ الفئة</button>
                    </div>
                </form>
            </div>
            <div class="categories-section col-12">
                <h3>الفئات الحالية</h3>
                <div class="category-list">
                    {% for category in categories %}
                    <div class="category-item">
                        <span class="category-name">{{ category.name }}</span>
                        <div class="action-buttons">
                            <a href="{% url 'menu:edit_category' category.id %}" class="action-btn edit-btn"><i class="fas fa-pen"></i></a>
                            <form method="POST" action="{% url 'menu:delete_category' category.id %}" onsubmit="return confirm('هل أنت متأكد من حذف هذه الفئة؟ سيتم حذف جميع المنتجات بداخلها.');" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="action-btn delete-btn"><i class="fas fa-trash"></i></button>
                            </form>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">لا توجد فئات لعرضها.</div>
                    {% endfor %}
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Add Product Modal -->
<div id="productModal" class="modal-overlay">
    <div class="modal-content">
        <header class="modal-header"><h2>إضافة منتج جديد</h2><button class="close-btn">&times;</button></header>
        <main class="modal-body">
            <form method="POST" action="{% url 'menu:menu_view' %}" style="width: 100%;" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="form-group">
                        <label for="product-name">اسم المنتج</label>
                        <input type="text" name="name" id="product-name" placeholder="مثال: كابتشينو" required>
                    </div>
                    <div class="form-group">
                        <label for="product-price">السعر</label>
                        <input type="number" name="price" id="product-price" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label for="product-category">الفئة</label>
                        <select name="category" id="product-category" required>
                            <option value="">اختر الفئة</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-image">رابط الصورة</label>
                        <input type="url" name="image" id="product-image" placeholder="https://...">
                    </div>
                    <div class="form-group full-width">
                        <label for="product-description">الوصف</label>
                        <textarea name="description" id="product-description" rows="3" placeholder="وصف المنتج..."></textarea>
                    </div>
                </div>
                <div class="modal-footer"><button type="submit" name="add_product" class="btn btn-orange">حفظ المنتج</button></div>
            </form>
        </main>
    </div>
</div>

<script src="{% static 'js/menu.js' %}"></script>
{% endblock dashboard_content %}