{% extends "home/base.html" %}
{% load static %}

{% block title %}ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª â€“ HalaOrder{% endblock %}

{% block style %}
<style>
:root{--brand:#00AAB0;--ink:#0f172a;--muted:#64748b;--soft:#f6fbfc;--card:#fff;--border:#e5e7eb}
.container{display:flex;flex-direction:column;gap:16px}
.topbar{display:flex;align-items:center;justify-content:space-between}
.identity{display:flex;align-items:center;gap:10px}
.identity .avatar{width:42px;height:42px;border-radius:999px;background:#e6fffb;display:grid;place-items:center}
.identity .rest{font-weight:700}
.actions{display:flex;gap:8px}
.btn{border:0;border-radius:10px;padding:9px 14px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--brand);color:#fff}
.btn-ghost{background:#fff;border:1px solid var(--border)}
.filters{display:grid;gap:8px;grid-template-columns:140px 180px 180px 1fr 120px}
.select,.input{border:1px solid var(--border);border-radius:10px;padding:8px 10px;width:100%}
.kpis{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
.kpi .t{font-size:12px;color:var(--muted)} .kpi .v{font-size:24px;font-weight:800}
.grid-2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
.grid-3{display:grid;gap:12px;grid-template-columns:1fr 1fr 1fr}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th,.table td{background:#fff;border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:10px 12px}
.table th{font-weight:700;color:#334155}
.table tr th:first-child,.table tr td:first-child{border-radius:10px 0 0 10px}
.table tr th:last-child,.table tr td:last-child{border-radius:0 10px 10px 0}
.small{font-size:12px;color:#64748b}
@media(max-width:1100px){.kpis{grid-template-columns:repeat(2,1fr)}.grid-2{grid-template-columns:1fr}.grid-3{grid-template-columns:1fr}.filters{grid-template-columns:1fr 1fr 1fr}}
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container">

  <div class="topbar">
    <div class="identity">
      <div class="avatar"><i class="fas fa-chart-line" style="color:var(--brand)"></i></div>
      <div>
        <div class="rest">{{ request.user.restaurants.name|default:"Ù…Ø·Ø¹Ù…Ùƒ" }}</div>
        <div style="color:var(--muted);font-size:13px">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
      </div>
    </div>
    <div class="actions">
      <button id="btn-export" class="btn btn-ghost"><i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      <button id="btn-refresh" class="btn btn-primary"><i class="fas fa-rotate"></i> ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </div>

  <div class="card filters">
    <select id="branch" class="select">
      <option value="">ÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹</option>
      {% for b in branches %}<option value="{{ b.id }}">{{ b.name }}</option>{% endfor %}
    </select>
    <input id="from" type="date" class="input">
    <input id="to" type="date" class="input">
    <select id="otype" class="select">
      <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
      <option value="Ù…Ø­Ù„ÙŠ">Ù…Ø­Ù„ÙŠ</option>
      <option value="Ø§Ø³ØªÙ„Ø§Ù…">Ø§Ø³ØªÙ„Ø§Ù…</option>
      <option value="ØªÙˆØµÙŠÙ„">ØªÙˆØµÙŠÙ„</option>
    </select>
    <button id="apply" class="btn btn-ghost">ØªØ·Ø¨ÙŠÙ‚</button>
  </div>

  <div class="kpis">
    <div class="card kpi"><div class="t">(2+) Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…ØªÙƒØ±Ø±ÙˆÙ†</div><div class="v" id="kpi-returning">â€“</div></div>
    <div class="card kpi"><div class="t">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø·Ù„Ø¨</div><div class="v" id="kpi-avg">â€“</div></div>
    <div class="card kpi"><div class="t">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div><div class="v" id="kpi-orders">â€“</div></div>
    <div class="card kpi"><div class="t">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div><div class="v" id="kpi-revenue">â€“</div></div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹</div>
      <canvas id="c-branch" height="220"></canvas>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</div>
      <canvas id="c-type" height="220"></canvas>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <div style="font-weight:700">Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø­ØªÙ…Ù„ ÙÙ‚Ø¯Ø§Ù†Ù‡Ù…</div>
        <div class="small">Ù„Ù… ÙŠØ·Ù„Ø¨ÙˆØ§ Ù…Ù†Ø° <input id="inactive-days" type="number" value="30" min="7" max="180" style="width:60px"> ÙŠÙˆÙ…</div>
      </div>
      <table class="table" id="tbl-inactive">
        <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø¢Ø®Ø± Ø·Ù„Ø¨</th><th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th><th>Ø§Ù„ØµØ±Ù</th><th>ÙˆØ§ØªØ³Ø§Ø¨</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø¢Ø®Ø± 30 ÙŠÙˆÙ…)</div>
      <table class="table" id="tbl-top">
        <thead><tr><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø¢Ø®Ø± Ø·Ù„Ø¨</th><th>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th><th>Ø§Ù„ØµØ±Ù</th><th>ÙˆØ§ØªØ³Ø§Ø¨</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ©</div>
      <div class="small" style="margin-bottom:6px">Ø³Ø§Ø¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
      <canvas id="c-hours" height="180"></canvas>
      <div class="small" style="margin-top:10px;margin-bottom:6px">Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
      <canvas id="c-week" height="180"></canvas>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:6px">Ø¨Ø§Ù‚Ø§Øª Ù…Ù†ØªØ¬Ø§Øª Ù…Ù‚ØªØ±Ø­Ø©</div>
      <table class="table" id="tbl-bundles">
        <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬ A</th><th>Ø§Ù„Ù…Ù†ØªØ¬ B</th><th>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ø¹Ù‹Ø§</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="small" style="margin-top:6px">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„ØµÙ†Ø¹ Ø¹Ø±ÙˆØ¶ Ù…Ø¬Ù…Ù‘Ø¹Ø©.</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div style="font-weight:700">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
    </div>
    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ÙØ±Ø¹</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<div class="grid-2" style="margin-top:12px">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ: Ù†ØµÙˆØµ ØªØ±ÙˆÙŠØ¬ÙŠØ©</div>
      <div style="display:flex;gap:8px">
        <select id="ai-style" class="select" style="width:160px">
          <option value="friendly">ÙˆØ¯ÙŠ</option>
          <option value="formal">Ø±Ø³Ù…ÙŠ</option>
          <option value="playful">Ù…Ø±Ø­</option>
        </select>
        <input id="ai-offer" class="input" type="number" value="10" min="1" max="90" style="width:90px">
        <button id="btn-ai" class="btn btn-primary">ØªÙˆÙ„ÙŠØ¯</button>
      </div>
    </div>
    <ul id="ai-out" style="margin-top:10px;list-style:disc;padding-inline-start:20px"></ul>
  </div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">ØªØ³ÙˆÙŠÙ‚: ØªØµØ¯ÙŠØ± ÙˆØ§ØªØ³Ø§Ø¨ CSV</div>
      <div style="display:flex;gap:8px">
        <select id="mk-kind" class="select" style="width:180px">
          <option value="inactive">Ø¹Ù…Ù„Ø§Ø¡ Ø®Ø§Ù…Ù„ÙˆÙ†</option>
          <option value="top">Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©)</option>
        </select>
        <input id="mk-offer" class="input" type="number" value="10" min="1" max="90" style="width:90px">
        <button id="btn-mk" class="btn btn-ghost">ØªØµØ¯ÙŠØ± CSV</button>
      </div>
    </div>
    <div class="small" style="margin-top:6px">Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨/CRM.</div>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const asMoney = v => (v||0).toLocaleString('ar-SA',{minimumFractionDigits:2,maximumFractionDigits:2})+' Ø±.Ø³';
const api = async (url)=>{const r=await fetch(url,{headers:{'X-Requested-With':'XMLHttpRequest'}});if(!r.ok)throw new Error(r.status);return r.json();}

const qs = ()=>{
  const p = new URLSearchParams();
  const b = document.getElementById('branch').value; if(b) p.set('branch', b);
  const f = document.getElementById('from').value;   if(f) p.set('start', f);
  const t = document.getElementById('to').value;     if(t) p.set('end', t);
  const o = document.getElementById('otype').value;  if(o) p.set('otype', o);
  return p.toString()?('?'+p.toString()):'';
}

function drawBar(ctxId, labels, values){
  if(window[ctxId]) window[ctxId].destroy?.();
  const ctx = document.getElementById(ctxId);
  window[ctxId] = new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',data:values}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}

function drawDoughnut(ctxId, labels, values){
  if(window[ctxId]) window[ctxId].destroy?.();
  const ctx = document.getElementById(ctxId);
  window[ctxId] = new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data:values}]},options:{plugins:{legend:{position:'bottom'}}}});
}

function drawLine(ctxId, labels, values){
  if(window[ctxId]) window[ctxId].destroy?.();
  const ctx = document.getElementById(ctxId);
  window[ctxId] = new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',data:values,tension:.3,fill:false}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}

function fillKPIs(k){
  document.getElementById('kpi-returning').textContent = (k.returning||0).toLocaleString('ar-SA');
  document.getElementById('kpi-avg').textContent       = asMoney(k.avg||0);
  document.getElementById('kpi-orders').textContent    = (k.orders||0).toLocaleString('ar-SA');
  document.getElementById('kpi-revenue').textContent   = asMoney(k.revenue||0);
}

function fillTable(rows){
  const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const when = r.created? new Date(r.created).toLocaleString('ar-SA') : '-';
    tr.innerHTML = `
      <td>${r.no||('-#'+(r.id||''))}</td>
      <td>${when}</td>
      <td>${r.customer||'-'}</td>
      <td>${r.branch||'-'}</td>
      <td>${r.otype||'-'}</td>
      <td>${r.payment||'-'}</td>
      <td>${asMoney(r.total)}</td>`;
    tb.appendChild(tr);
  });
}

function renderGrowth(tableId, rows, msg){
  const tb = document.querySelector(`#${tableId} tbody`); tb.innerHTML='';
  rows.forEach(r=>{
    const when = r.last? new Date(r.last).toLocaleDateString('ar-SA') : '-';
    const phone = (r.phone||'').toString().replace(/\s+/g,'');
    const goodPhone = /^\+?\d{8,15}$/.test(phone);
    const link = goodPhone ? `https://wa.me/${phone.replace('+','')}?text=${encodeURIComponent(msg.replace('{name}', r.name||'Ø¹Ù…ÙŠÙ„Ù†Ø§'))}` : null;
    const wa = link ? `<a class="btn btn-ghost" href="${link}" target="_blank">ÙˆØ§ØªØ³Ø§Ø¨</a>` : 'â€“';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name||'-'}</td><td>${when}</td><td>${r.orders||0}</td><td>${asMoney(r.spent||0)}</td><td>${wa}</td>`;
    tb.appendChild(tr);
  });
}

function renderBundles(rows){
  const tb = document.querySelector('#tbl-bundles tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.a}</td><td>${r.b}</td><td>${r.count}</td>`;
    tb.appendChild(tr);
  });
}

async function refresh(){
  const to = document.getElementById('to'), from = document.getElementById('from');
  if(!to.value){const d=new Date(); to.value=d.toISOString().slice(0,10);}
  if(!from.value){const d=new Date(); d.setDate(d.getDate()-29); from.value=d.toISOString().slice(0,10);}
  const q = qs();

  const kpi = await api("{% url 'reports:api_sales_summary' %}"+q); fillKPIs(kpi.kpi||{});
  const byb = await api("{% url 'reports:api_sales_by_branch' %}"+q); drawBar('c-branch', byb.labels||[], byb.values||[]);
  const byt = await api("{% url 'reports:api_sales_by_type' %}"+q);   drawDoughnut('c-type', byt.labels||[], byt.values||[]);
  const lst = await api("{% url 'reports:api_sales_list' %}"+q);      fillTable(lst.rows||[]);

  const days = parseInt(document.getElementById('inactive-days').value || '30', 10);
  const msgInactive = `Ù…Ø±Ø­Ø¨Ø§ {name}! ÙˆØ­Ø´Ù†Ø§ Ø°ÙˆÙ‚Ùƒ ğŸ˜ Ø¹Ù†Ø¯Ùƒ Ø®ØµÙ… 10% Ø§Ù„ÙŠÙˆÙ… ÙÙŠ {{ request.user.restaurants.name|default:"Ù…Ø·Ø¹Ù…Ù†Ø§" }}. Ù†ÙˆØ±ØªÙ†Ø§!`;
  const msgTop      = `Ø£Ù‡Ù„Ù‹Ø§ {name} ğŸŒŸ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¯Ø§Ø¦Ù…! Ù‡Ø¯ÙŠØ© 10% Ù„Ø·Ù„Ø¨Ùƒ Ø§Ù„Ù‚Ø§Ø¯Ù… ÙÙŠ {{ request.user.restaurants.name|default:"Ù…Ø·Ø¹Ù…Ù†Ø§" }}`;
  const inactive = await api("{% url 'reports:api_growth_reengage' %}?days="+days); renderGrowth('tbl-inactive', inactive.rows||[], msgInactive);
  const top = await api("{% url 'reports:api_growth_top_customers' %}"+q);         renderGrowth('tbl-top', top.rows||[], msgTop);

  const best = await api("{% url 'reports:api_growth_best_times' %}"+q);
  drawLine('c-hours', best.hours.labels||[], best.hours.values||[]);
  drawBar('c-week', best.weekdays.labels||[], best.weekdays.values||[]);

  const bundles = await api("{% url 'reports:api_growth_bundles' %}"+q);
  renderBundles(bundles.rows||[]);
}

document.getElementById('apply').addEventListener('click', refresh);
document.getElementById('btn-refresh').addEventListener('click', refresh);
document.getElementById('inactive-days').addEventListener('change', refresh);
document.getElementById('btn-export').addEventListener('click', ()=>{ window.location = "{% url 'reports:api_sales_export' %}"+qs(); });
refresh();
</script>

<script>
async function aiPromo(){
  const offer = document.getElementById('ai-offer').value || 10;
  const style = document.getElementById('ai-style').value || 'friendly';
  const r = await fetch("{% url 'reports:api_ai_promo' %}?offer="+offer+"&style="+style,{headers:{'X-Requested-With':'XMLHttpRequest'}});
  const j = await r.json();
  const ul = document.getElementById('ai-out'); ul.innerHTML='';
  (j.messages||[]).forEach(m=>{ const li=document.createElement('li'); li.textContent=m; ul.appendChild(li); });
}
document.getElementById('btn-ai')?.addEventListener('click', aiPromo);

function exportWA(){
  const kind  = document.getElementById('mk-kind').value || 'inactive';
  const offer = document.getElementById('mk-offer').value || 10;
  const url = "{% url 'reports:api_marketing_whatsapp_csv' %}?kind="+kind+"&offer="+offer;
  window.location = url;
}
document.getElementById('btn-mk')?.addEventListener('click', exportWA);
</script>
{% endblock %}
