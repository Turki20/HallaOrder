{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>{% block title %}{% firstof website.restaurant.name website.display_name website.slug %}{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    /* حمايات عامة */
    img{max-width:100%;height:auto;vertical-align:middle}
    .hoa-page{min-height:100vh;display:flex;flex-direction:column;background:#f6f7fb}
    main{flex:1}

    /* Topbar */
    .hoa-topbar{background:#fff;border-bottom:1px solid #eef2f7;position:sticky;top:0;z-index:50}
    .hoa-container{max-width:1120px;margin:auto;padding:0 16px}
    .hoa-topbar__inner{display:flex;align-items:center;gap:12px;padding:10px 0;position:relative}
    .hoa-logo{width:36px;height:36px;border-radius:10px;overflow:hidden;background:#eef2f7;display:inline-flex;align-items:center;justify-content:center}
    .hoa-title{font-weight:800}
    .hoa-nav{display:flex;gap:16px;background:#f0f2f6;border-radius:24px;padding:8px 12px;position:absolute;left:50%;transform:translateX(-50%)}
    .hoa-pill{padding:10px 22px;border:0;background:#fff;border-radius:18px;font-weight:500}
    .hoa-pill.active,.hoa-pill:hover{background:#ff7f50;color:#fff;box-shadow:0 4px 10px rgba(255,127,80,.35)}
    .hoa-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .hoa-badge{min-width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;background:#ff7a45;color:#fff;border-radius:8px;font-size:12px;padding:0 6px}

    /* شريط الأدوات */
    .hoa-toolbar{display:flex;gap:8px;align-items:center;margin:12px 0}
    .hoa-input{flex:1;padding:12px 14px;border:1px solid #eef1f5;border-radius:12px;background:#f6f7fb;color:#9aa3ad}

    /* Drawer (سلة) — أسماء مُسمّاة لمنع التعارض */
    .hoa-drawer{position:fixed;inset:0;display:none}
    .hoa-drawer.is-open{display:block}
    .hoa-mask{position:absolute;inset:0;background:rgba(0,0,0,.25)}
    .hoa-panel{position:absolute;inset-inline-end:0;top:0;height:100%;width:min(420px,90%);background:#fff;box-shadow:0 10px 20px rgba(0,0,0,.04);display:flex;flex-direction:column}
    .hoa-panel header{padding:14px 16px;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center}
    .hoa-list{padding:12px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:8px}
    .hoa-item{display:flex;gap:10px;border:1px solid #f0f2f5;border-radius:12px;padding:10px;background:#fff}
    .hoa-item-img{width:64px;height:64px;border-radius:10px;object-fit:cover;background:#f3f4f6}
    .hoa-panel footer{padding:12px 16px;border-top:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center}
    .hoa-btn-primary{padding:10px 14px;border:0;border-radius:12px;background:#0ea5e9;color:#fff;cursor:pointer}
    .hoa-btn-ghost{padding:10px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;color:#111;cursor:pointer}

    /* Footer */
    .hoa-footer{background:#fff;border-top:1px solid #eef2f7;margin-top:24px}
    .hoa-footer__inner{max-width:1120px;margin:auto;padding:20px 16px}
    .hoa-footer-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .hoa-footer-grid h4{margin:0 0 10px;font-size:16px}
    .hoa-footer-bottom{margin-top:12px;border-top:1px solid #eef2f7;padding-top:12px;text-align:center;color:#6b7280;font-size:13px}
    @media(max-width:720px){.hoa-footer-grid{grid-template-columns:1fr}}

    /* زر السلة كقرص مع شارة */
    #hoa-open-cart{position:relative;display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;background:#fff4ef;color:#ff7f50;border:1px solid #ffe1d6;margin-inline-start:auto}
    #hoa-open-cart .hoa-badge{position:absolute;top:-6px;inset-inline-start:-6px;background:#e74c3c;color:#fff;border-radius:999px}
    #hoa-open-cart span:last-child{display:none}
  </style>
  {% block head %}{% endblock %}
</head>
<body>
<div class="hoa-page">

  <!-- Topbar -->
  <header class="hoa-topbar">
    <div class="hoa-container hoa-topbar__inner">
      <div class="hoa-logo">
        {% if website.logo %}
          <img src="{{ website.logo.url }}" alt="logo" style="width:100%;height:100%;object-fit:cover">
        {% else %}
          <img src="{% static 'images/placeholders/logo-placeholder.svg' %}" alt="logo" style="width:100%;height:100%;object-fit:cover">
        {% endif %}
      </div>
      <div class="hoa-title">{% firstof website.restaurant.name website.display_name website.slug %}</div>

      {# توليد آمن لمسارات الدخول/الخروج #}
      {% url 'logout' as logout_url %}{% if not logout_url %}{% url 'users:logout' as logout_url %}{% endif %}{% if not logout_url %}{% url 'account_logout' as logout_url %}{% endif %}
      {% url 'login'  as login_url  %}{% if not login_url  %}{% url 'users:login'  as login_url  %}{% endif %}{% if not login_url  %}{% url 'account_login'  as login_url  %}{% endif %}

      <nav class="hoa-nav">
        <a class="hoa-pill {% if current_tab == 'home' %}active{% endif %}" href="{% url 'websites:menu' website.slug %}">داخل المطعم</a>
        <a class="hoa-pill {% if current_tab == 'pickup' %}active{% endif %}" href="#">استلام</a>
        <a class="hoa-pill {% if current_tab == 'delivery' %}active{% endif %}" href="#">توصيل</a>
      </nav>

      <button class="hoa-btn" id="hoa-open-cart" type="button" aria-haspopup="dialog" aria-controls="hoa-cart-drawer">
        <span class="hoa-badge">{{ cart_count|default:0 }}</span>
        <i class="bi bi-basket2"></i>
        <span>السلة</span>
      </button>

      {% if request.user.is_authenticated %}
        {% if logout_url %}<a class="hoa-btn" href="{{ logout_url }}?next={{ request.path }}">خروج</a>{% endif %}
      {% else %}
        {% if login_url %}<a class="hoa-btn" href="{{ login_url }}?next={{ request.path }}">دخول</a>{% endif %}
      {% endif %}
    </div>
  </header>

  <!-- Toolbar -->
  <div class="hoa-container hoa-toolbar">
    <input class="hoa-input" type="search" placeholder="ابحث في الأصناف…">
    {% block toolbar_extra %}{% endblock %}
  </div>

  <!-- Main -->
  <main>
    <div class="hoa-container">
      {% block content %}
      <section class="card" style="padding:18px">
        <p>مرحبًا بك في <b>{% firstof website.restaurant.name website.display_name website.slug %}</b>.</p>
      </section>
      {% endblock %}
    </div>
  </main>

  <!-- Footer -->
  <footer class="hoa-footer">
    <div class="hoa-footer__inner">
      <div class="hoa-footer-grid">
        <div>
          <h4>{% firstof website.restaurant.name website.display_name website.slug %}</h4>
          <p class="muted">تجربة طلب سهلة وسريعة؛ داخل المطعم أو للاستلام أو التوصيل.</p>
        </div>
        <div>
          <h4>روابط سريعة</h4>
          <div style="display:flex;flex-direction:column;gap:6px">
            <a href="{% url 'websites:menu' website.slug %}">القائمة</a>
            <a href="{% url 'websites:cart' website.slug %}">السلة</a>
            <a href="#">سياسة الخصوصية</a>
          </div>
        </div>
        <div>
          <h4>تواصل</h4>
          <div class="muted">العنوان: {% firstof website.restaurant.address "—" %}</div>
          <div class="muted">الهاتف: {% firstof website.restaurant.phone "—" %}</div>
        </div>
      </div>
      <div class="hoa-footer-bottom">تم بناء هذا المتجر بواسطة <b>HalaOrder</b>. جميع الحقوق محفوظة.</div>
    </div>
  </footer>

</div>

<!-- Cart Drawer (namespaced) -->
<div class="hoa-drawer" id="hoa-cart-drawer" aria-hidden="true">
  <div class="hoa-mask" id="hoa-close-cart"></div>
  <aside class="hoa-panel" role="dialog" aria-label="سلة المشتريات">
    <header>
      <div>سلة مشترياتك</div>
      <button class="hoa-btn-ghost" id="hoa-close-cart-btn" type="button">إغلاق</button>
    </header>
    <div class="hoa-list">
      {% if cart and cart|length %}
        {% for i in cart %}
        <div class="hoa-item">
          {% if i.image %}<img class="hoa-item-img" src="{{ i.image }}" alt="">{% endif %}
          <div style="flex:1">
            <div><b>{{ i.name }}</b> <span class="muted">× {{ i.qty }}</span></div>
            <div class="muted">{% if i.size %}الحجم: {{ i.size }} — {% endif %}السعر: SAR {{ i.price }}</div>
          </div>
          <form method="post" action="{% url 'websites:remove_from_cart' website.slug forloop.counter0 %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="hoa-btn-ghost" type="submit" title="حذف"><i class="bi bi-x-lg"></i></button>
          </form>
        </div>
        {% endfor %}
      {% else %}
        <div class="muted">سلتك فارغة.</div>
      {% endif %}

      {% if request.user.is_authenticated %}
        {% if logout_url %}<a href="{{ logout_url }}?next={{ request.path }}">تسجيل الخروج</a>{% endif %}
      {% else %}
        {% if login_url %}<a href="{{ login_url }}?next={{ request.get_full_path|urlencode }}">الدخول</a>{% endif %}
      {% endif %}
    </div>
    <footer>
      <a class="hoa-btn-primary" href="{% url 'websites:cart' website.slug %}">إتمام الطلب</a>
      <span class="muted">العناصر: {{ cart_count|default:0 }}</span>
    </footer>
  </aside>
</div>

<script>
  // Drawer بدون تعارض أسماء
  const drawer = document.getElementById('hoa-cart-drawer');
  const openBtn = document.getElementById('hoa-open-cart');
  const closeMask = document.getElementById('hoa-close-cart');
  const closeBtn = document.getElementById('hoa-close-cart-btn');

  [openBtn, closeMask, closeBtn].forEach(el=>{
    if(!el) return;
    el.addEventListener('click', ()=>{
      drawer.classList.toggle('is-open');
      drawer.setAttribute('aria-hidden', drawer.classList.contains('is-open') ? 'false' : 'true');
    });
  });
</script>

{% block extra_js %}{% endblock %}
</body>
</html>